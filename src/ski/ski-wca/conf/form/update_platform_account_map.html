<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>补充信息</title>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/style/weui.min.css'/>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/example/example.css'/>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery-3.0.0.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.json.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.cookie.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/ski.js'></script>
        <script type='text/javascript'>
            var url_setup = '/ski-wcweb?inst=240a&step=setup';
            var url_apply = '/ski-wcweb?inst=240a&step=apply';

            function setup() {
                var phone = $('#phone').val();
                if (!verifyPhone(phone)) return;

                if ($('#btn_setup').hasClass('weui_btn_disabled')) return;

                var time = 60;
                var text_origin = $('#btn_setup').text();

                $('#btn_setup').addClass('weui_btn_disabled');
                $('#btn_setup').text('重试(' + time + ')');
                var timer = setInterval(function() {
                    time--;
                    $('#btn_setup').text('重试(' + time + ')');
                    if(time <= 0) {
                        clearInterval(timer);
                        $('#btn_setup').removeClass('weui_btn_disabled');
                        $('#btn_setup').text(text_origin);
                    }
                },1000); 

                $.post(url_setup, $.toJSON({
                        'phone' : phone
                    }),
                    function(args) {
                        if (0 != args.code) {
                            showDialog('获取失败', args.desc);
                        }
                    });
            }

            function apply() {
                var phone = $('#phone').val();
                var verify = $('#verify').val();

                if (!verifyPhone(phone)) return;

                if (0 == verify.length) {
                    showDialog('错误', '验证码不能为空');
                    return;
                }

                showToast('正在处理');
                $.post(url_apply, $.toJSON({
                        'phone'     : phone,
                        'verify'    : verify
                    }),
                    function(args) {
                        hideToast();
                        if (0 == args.code) {
                            showDialog("验证通过", '');
                            $('#result_conf').attr('href', 'javascript: history.go(-1)');
                        } else {
                            showDialog("验证不通过", args.desc);
                        }
                    });
            }

            function verifyPhone(phone) {
                if (0 == phone.length) {
                    showDialog('错误', '手机不能为空');
                    return false;
                }
                if(!(/^1[3|4|5|7|8]\d{9}$/.test(phone))) {
                    showDialog('错误', '手机号码不合法');
                    return false;
                }
                return true;
            }

            function showToast(text) {
                $('#toast_text').text(text);
                $('#toast').show();
            }
            function hideToast() {
                $('#toast').hide();
            }

            function showDialog(head, body) {
                $('#result_head').text(head);
                $('#result_body').text(body);
                $('#dialog').show();
            }
        </script>
    </head>
    <body>
        <div class='cell'>
            <div class='hd'>
                <h1 class='page_title'>补充信息</h1>
            </div>
            <div class='bd'>
                <div class='weui_cells_title'>认证手机以便于跟您的淘宝帐号关联</div>
                <div class='weui_cells weui_cells_form'>
                    <div class='weui_cell'>
                        <div class='weui_cell_hd'><label class='weui_label'></label>手机</div>
                        <div class='weui_cell_bd weui_cell_primary'><input class='weui_input' id='phone'/></div>
                    </div>
                    <div class='weui_cell'>
                        <div class='weui_cell_hd'><label class='weui_label'></label>验证码</div>
                        <div class='weui_cell_bd weui_cell_primary'><input class='weui_input' id='verify'/></div>
                        <a class='weui_btn weui_btn_mini weui_btn_primary' href="javascript:setup()" id='btn_setup'>获取</a>
                    </div>
                </div>
                <div class='weui_btn_area'>
                    <a class='weui_btn weui_btn_primary' href="javascript:apply()">提交</a>
                </div>
            </div>
        </div>
        <div class="weui_dialog_alert" id="dialog" style='display:none'>
            <div class="weui_mask"></div>
            <div class="weui_dialog">
                <div class="weui_dialog_hd"><strong class="weui_dialog_title" id='result_head'></strong></div>
                <div class="weui_dialog_bd" id='result_body'></div>
                <div class="weui_dialog_ft">
                    <a class="weui_btn_dialog primary" href="javascript:$('#dialog').hide();" id='result_conf'>确定</a>
                </div>
            </div>
        </div>
        <div class="weui_loading_toast" id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <div class="weui_loading">
                    <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                </div>
                <p class="weui_toast_content" id='toast_text'></p>
            </div>
        </div>
    </body>
</html>
