<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>充值</title>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/style/weui.min.css'/>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/example/example.css'/>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery-3.0.0.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.json.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.cookie.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/ski.js'></script>
        <script type='text/javascript' src='http://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
        <script type='text/javascript'>
            var appId       = ski.cookie('appid');
            var timestamp   = ski.cookie('timestamp');
            var nonceStr    = ski.cookie('noncestr');
            var signature   = ski.cookie('signature');

            var url_apply   = '/ski-wcweb/pay/recharge?inst=2104&step=apply';
            var url_success = '/ski-wcweb/pay/recharge?inst=2104&step=success';

            wx.config({
                    'debug'     : false,        // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    'appId'     : appId,        // 必填，公众号的唯一标识
                    'timestamp' : timestamp,    // 必填，生成签名的时间戳
                    'nonceStr'  : nonceStr,     // 必填，生成签名的随机串
                    'signature' : signature,    // 必填，签名，见附录1
                    'jsApiList' : []            // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });

            function apply() {
                // 生成预支付订单
                var money = $('#money').val();
                if (0 == money.length) {
                    showDialog('错误', '金额不能为空');
                    return;
                }

                showToast('正在处理');
                $.post(url_apply, $.toJSON({
                            'money' : money
                        }), function(prepay) {
                            hideToast();
                            if ('SUCCESS' == prepay.return_code) {
                                // 调起支付
                                wx.chooseWXPay({
                                    'appId'     : prepay.pay.appId,     // 必填，公众号的唯一标识
                                    'timestamp' : prepay.pay.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                                    'nonceStr'  : prepay.pay.nonceStr,  // 支付签名随机串，不长于 32 位
                                    'package'   : prepay.pay.package,   // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                                    'signType'  : prepay.pay.signType,  // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                                    'paySign'   : prepay.pay.paySign,   // 支付签名
                                    'success'   : function (res) {
                                        window.location = url_success;
                                    }
                                });
                            } else {
                                showDialog("创建订单失败", prepay.return_msg);
                            }
                        });
            }

            function showToast(text) {
                $('#toast_text').text(text);
                $('#toast').show();
            }
            function hideToast() {
                $('#toast').hide();
            }

            function showDialog(head, body) {
                $('#result_head').text(head);
                $('#result_body').text(body);
                $('#dialog').show();
            }
        </script>
    </head>
    <body>
        <div class='cell'>
            <div class='hd'>
                <h1 class='page_title'>充值</h1>
            </div>
            <div class='bd'>
                <div class='weui_cells_title'>选择金额</div>
                <div class='weui_cells'>
                    <div class="weui_cell weui_cell_select weui_select_after">
                        <div class="weui_cell_hd">
                            <label class="weui_label" for="">充值金额</label>
                        </div>
                        <div class="weui_cell_bd weui_cell_primary">
                            <select name="select" class="weui_select" id='money'>
                                <option value="20">20元</option>
                                <option value="50">50元</option>
                                <option value="120" selected='selected'>120元</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class='weui_cells_tips'>账户余额可以全额退款，请放心充值</div>
                <div class='weui_btn_area'>
                    <a class='weui_btn weui_btn_primary' href="javascript:apply();">充值</a>
                </div>
            </div>
        </div>
        <div class="weui_dialog_alert" id="dialog" style='display:none'>
            <div class="weui_mask"></div>
            <div class="weui_dialog">
                <div class="weui_dialog_hd"><strong class="weui_dialog_title" id='result_head'></strong></div>
                <div class="weui_dialog_bd" id='result_body'></div>
                <div class="weui_dialog_ft">
                    <a class="weui_btn_dialog primary" href="javascript:$('#dialog').hide();">确定</a>
                </div>
            </div>
        </div>
        <div class="weui_loading_toast" id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <div class="weui_loading">
                    <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                </div>
                <p class="weui_toast_content" id='toast_text'></p>
            </div>
        </div>
    </body>
</html>
