<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>我的游戏</title>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/style/weui.min.css'/>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/example/example.css'/>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery-3.0.0.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.json.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.cookie.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/ski.js'></script>
        <script type='text/javascript'>
            var url_setup       = '/ski-wcweb?inst=2006&step=setup';
            var url_rent_end    = '/ski-wcweb?inst=2107';
            var url_query_game  = '/ski-wcweb?inst=2001';

            $(document).ready(function() {
                showToast('正在加载');
                $.get(url_setup, function(args) {
                    hideToast();
                    if (0 != args.code) {
                        showDialog("加载失败", args.desc);
                        return;
                    }
                    for (var i in args.desc) {
                        var commodity = args.desc[i];

                        var cells = document.createElement('div');
                        cells.className = 'weui_cells';
                        cells.innerHTML = "<a class='weui_cell' href='" + (url_query_game + '&gid=' + commodity.game.gid.toString(16)) + "'>"
                                                + "<div class='weui_cell_bd weui_cell_primary'><p>《" + commodity.game.name_zh_cn + "》</p></div>"
                                                + "<div class='weui_cell_ft'>" + commodity.account + "</div>"
                                        + "</a>"
                                        + (typeof(commodity.pass) != 'undefined' ? "<div class='weui_cell'><div class='weui_cell_bd weui_cell_primary'><p>密码</p></div><div class='weui_cell_ft'>" + commodity.pass + "</div></div>" : "")
                                        + "<div class='weui_cell'><div class='weui_cell_bd weui_cell_primary'><p>租赁类型</p></div><div class='weui_cell_ft'>" + commodity.type + " (" + commodity.price + "元/天)</div></div>"
                                        + "<div class='weui_cell'><div class='weui_cell_bd weui_cell_primary'><p>租赁时间</p></div><div class='weui_cell_ft'>" + commodity.begin.substring(5) + " ~ " + ('' == commodity.end ? '(尚未退租)' : commodity.end.substring(5)) + "</div></div>"
                                        + "<div class='weui_cell'><div class='weui_cell_bd weui_cell_primary'><p>消费总计</p></div><div class='weui_cell_ft'>" + commodity.expense + "元</div></div>";

                        if ('' == commodity.end) {
                            var rent_end = document.createElement('div');
                            rent_end.className = 'weui_btn_area';
                            rent_end.style.margin = '0';
                            rent_end.innerHTML = "<a href='javascript:rentEnd(" + commodity.oid + ", " + commodity.csn + ");' class='weui_btn weui_btn_primary'>退租</a>";

                            $('#result_now').append(cells);
                            $('#result_now').append(rent_end);
                        } else {
                            $('#result_old').append(cells);
                        }
                    }
                });
            });

            function rentEnd(oid, csn) {
               window.location = url_rent_end + '&oid=' + oid.toString(16) + '&csn=' + csn.toString(16); 
            }

            function switchToNow() {
                $('#result_now_label').addClass('weui_bar_item_on');
                $('#result_old_label').removeClass('weui_bar_item_on');
                $('#result_now').show();
                $('#result_old').hide();
            }

            function switchToOld() {
                $('#result_now_label').removeClass('weui_bar_item_on');
                $('#result_old_label').addClass('weui_bar_item_on');
                $('#result_now').hide();
                $('#result_old').show();
            }

            function showToast(text) {
                $('#toast_text').text(text);
                $('#toast').show();
            }
            function hideToast() {
                $('#toast').hide();
            }

            function showDialog(head, body) {
                $('#result_head').text(head);
                $('#result_body').text(body);
                $('#dialog').show();
            }
        </script>
    </head>
    <body>
        <div class='navbar'>
            <div class='bd' style='height: 100%'>
                <div class="weui_tab">
                    <div class="weui_navbar">
                        <div class="weui_navbar_item weui_bar_item_on" id='result_now_label' onclick='switchToNow()'>正在玩</div>
                        <div class="weui_navbar_item" id='result_old_label' onclick='switchToOld()'>已退租</div>
                    </div>
                    <div class="weui_tab_bd">
                        <div id='result_now'></div>
                        <div style='display:none' id='result_old'></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="weui_dialog_alert" id="dialog" style='display:none'>
            <div class="weui_mask"></div>
            <div class="weui_dialog">
                <div class="weui_dialog_hd"><strong class="weui_dialog_title" id='result_head'></strong></div>
                <div class="weui_dialog_bd" id='result_body'></div>
                <div class="weui_dialog_ft">
                    <a class="weui_btn_dialog primary" href="javascript:$('#dialog').hide();">确定</a>
                </div>
            </div>
        </div>
        <div class="weui_loading_toast" id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <div class="weui_loading">
                    <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                </div>
                <p class="weui_toast_content" id='toast_text'></p>
            </div>
        </div>
    </body>
</html>
