<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>关联账号</title>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/style/weui.min.css'/>
        <link rel='stylesheet' href='/ski-wcweb/weui/dist/example/example.css'/>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery-3.0.0.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/jquery.json.min.js'></script>
        <script type='text/javascript' src='/ski-wcweb/lib/ski.js'></script>
        <script type='text/javascript'>
            var user    = %d;
            var caid    = %s;   // decimal
            var channel = %s;   // decimal

            var url_setup   = '/ski-wcweb?inst=2405&user=' + user.toString(16) + '&step=setup';
            var url_apply   = '/ski-wcweb?inst=2405&user=' + user.toString(16) + '&step=apply';

            $(document).ready(function() {
                if (null != channel) {
                    $('#channel').val(channel);
                    $('#channel').attr('disabled', 'disabled');
                }
                if (null != caid) { // update user
                    showToast('正在加载');
                    $.post(url_setup, $.toJSON({
                           'caid'   : caid.toString(16)
                        }), function(args){
                            hideToast();
                            if (0 != args.code) {
                                showDialog('加载失败', args.desc);
                                return;
                            }
                            switch (args.desc.channel) {
                            case 0: // 淘宝
                                $('#label_user').text('昵称');
                                $('#cell_name').hide();
                                break;
                            case 1: // 微信
                                break;
                            case 2: // 支付宝
                                $('#label_user').text('帐号');
                                $('#label_name').text('真实姓名');
                                break;
                            }
                            $('#user').val(args.desc.user);
                            $('#name').val(args.desc.name);
                        });
                } else { // create user
                    $('#channel').val('0');
                    $('#label_user').text('昵称');
                    $('#cell_name').hide();

                    $('#channel').change(function() {
                        switch ($('#channel').val()) {
                        case '0':
                            $('#label_user').text('昵称');
                            $('#cell_name').hide();
                            break;
                        case '1':
                            break;
                        case '2':
                            $('#label_user').text('帐号');
                            $('#label_name').text('真实姓名');
                            $('#cell_name').show();
                            break;
                        }
                    });
                }
            });

            function apply() {
                var channel = $('#channel').val();
                var _user = $('#user').val();
                var name = $('#name').val();

                if (0 == _user.length) {
                    showDialog('错误', '账号不能为空');
                    return;
                }

                showToast('正在处理');
                var param = null;
                if (null == caid) {
                    param = $.toJSON({
                        'channel'   : channel.toString(16),
                        '_user'     : _user,
                        'name'      : name
                    });
                } else {
                    param = $.toJSON({
                        'caid'      : caid.toString(16),
                        'channel'   : channel.toString(16),
                        '_user'     : _user,
                        'name'      : name
                    });
                }
                $.post(url_apply, param,
                    function(args) {
                        hideToast();
                        if (0 == args.code) {
                            showDialog("提交成功");
                        } else {
                            showDialog("提交失败", args.desc);
                        }
                    });
            }

            function showToast(text) {
                $('#toast_text').text(text);
                $('#toast').show();
            }
            function hideToast() {
                $('#toast').hide();
            }

            function showDialog(head, body) {
                $('#result_head').text(head);
                $('#result_body').text(body);
                $('#dialog').show();
            }
        </script>
    </head>
    <body>
        <div class='cell'>
            <div class='hd'>
                <h1 class='page_title'>关联账号</h1>
            </div>
            <div class='bd'>
                <div class='weui_cells_title'>添加的用户将跟您的微信账号进行绑定</div>
                <div class='weui_cells weui_cells_form'>
                    <div class="weui_cell weui_cell_select weui_select_after">
                        <div class="weui_cell_hd">
                            <label class="weui_label" for="">平台</label>
                        </div>
                        <div class="weui_cell_bd weui_cell_primary">
                            <select name="select" class="weui_select" id='channel'>
                                <option value="0">淘宝</option>
                                <!--<option value="1">微信</option>-->
                                <option value="2">支付宝</option>
                            </select>
                        </div>
                    </div>
                    <div class='weui_cell'>
                        <div class='weui_cell_hd'>
                            <label class='weui_label' id='label_user'></label>
                        </div>
                        <div class='weui_cell_bd weui_cell_primary'>
                            <input class='weui_input' id='user'/>
                        </div>
                    </div>
                    <div class='weui_cell' id='cell_name'>
                        <div class='weui_cell_hd'>
                            <label class='weui_label' id='label_name'></label>
                        </div>
                        <div class='weui_cell_bd weui_cell_primary'>
                            <input class='weui_input' id='name'/>
                        </div>
                    </div>
                </div>
                <div class='weui_btn_area'>
                    <a class='weui_btn weui_btn_primary' href="javascript:apply()">提交</a>
                </div>
            </div>
        </div>
        <div class="weui_dialog_alert" id="dialog" style='display:none'>
            <div class="weui_mask"></div>
            <div class="weui_dialog">
                <div class="weui_dialog_hd"><strong class="weui_dialog_title" id='result_head'></strong></div>
                <div class="weui_dialog_bd" id='result_body'></div>
                <div class="weui_dialog_ft">
                    <a class="weui_btn_dialog primary" href="javascript:$('#dialog').hide();">确定</a>
                </div>
            </div>
        </div>
        <div class="weui_loading_toast" id="toast" style="display: none;">
            <div class="weui_mask_transparent"></div>
            <div class="weui_toast">
                <div class="weui_loading">
                    <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                    <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                </div>
                <p class="weui_toast_content" id='toast_text'></p>
            </div>
        </div>
    </body>
</html>
