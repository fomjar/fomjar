<!DOCTYPE html>
<html style='height: 100%;'>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>☕️聊天室</title>
        <link rel='stylesheet' href='/css/weui.css'/>
        <script type='text/javascript' src='/js/jquery.js'></script>
        <script type='text/javascript' src='/js/jquery.json.js'></script>
        <script type='text/javascript' src='/js/jquery.cookie.js'></script>
        <script type='text/javascript' src='/js/ski.js'></script>
        <script type='text/javascript' src='http://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
        <script type='text/javascript'>

            var gid = ski.urlparams().gid;
            var platform_account = null;
            var chatroom = null;
            var members  = null;
            var messages = [] 
            var page_open_time = new Date().format('yyyy-MM-dd HH:mm:ss');

            $(document).ready(function() {
                ski.ui.show_toast('获取个人信息');
                ski.common.query_platform_account(function(args) {
                    ski.ui.hide_toast();
                    if (0 != args.code) {
                        ski.ui.show_dialog_alert({
                            head : '获取个人信息失败',
                            body : args.desc
                        });
                        return;
                    }
                    platform_account = args.desc;

                    ski.ui.show_toast('获取聊天室');
                    ski.chatroom.get({gid : gid}, function(args) {
                        ski.ui.hide_toast();
                        if (0 != args.code) {
                            ski.ui.show_dialog_alert({
                                head : '获取聊天室失败',
                                body : args.desc
                            });
                            return;
                        }
                        chatroom = args.desc;
                        chatroom = chatroom[0]; // 先取第一个

                        ski.ui.show_toast('加入聊天室');
                        ski.chatroom.join(chatroom.crid, function(args) {
                            ski.ui.hide_toast();
                            if (0 != args.code) {
                                ski.ui.show_dialog_alert({
                                    head : '加入聊天室失败',
                                    body : args.desc
                                });
                                return;
                            }

                            ski.ui.show_toast('加载成员');
                            ski.chatroom.member(chatroom.crid, function(args) {
                                ski.ui.hide_toast();
                                if (0 != args.code) {
                                    ski.ui.show_dialog_alert({
                                        head : '加载成员失败',
                                        body : args.desc
                                    });
                                    return;
                                }
                                members = args.desc;

                                ski.ui.show_toast('加载消息');
                                ski.chatroom.message.get(chatroom.crid, {count : 100}, function(args) {
                                    ski.ui.hide_toast();
                                    if (0 != args.code) {
                                        ski.ui.show_dialog_alert({
                                            head : '加载消息失败',
                                            body : args.desc
                                        });
                                        return;
                                    }

                                    append_messages(args.desc);

                                    ski.chatroom.message.receive_start(
                                        chatroom.crid,
                                        1000,
                                        receive_message_condition,
                                        receive_message_callback
                                    );
									
									init();
                                });
                            });
                        });
                    });
                });
            });

            function scroll_bottom() {
                $(document.body)[0].scrollTop = (-1>>>2);
            }

            function init() {
                $('.weui_search_input').bind('focus', function(){
                    $('#operate_space').css('height', '0px');
                    $('.weui_search_bar').css('position', 'static');
                    $('#functions').hide();
                    scroll_bottom();
                });
                $('.weui_search_input').bind('blur', function(){
                    $('#operate_space').css('height', $('#searchbar').outerHeight(true)+'px');
                    $('.weui_search_bar').css('position', 'fixed');
                    $('#functions').show();
                    $('.weui_search_bar').css('bottom', '-'+$('#functions').height()+'px');
                    scroll_bottom();
                });
				
				ski.ui.set_title('☕️' + chatroom.game.name_zh_cn + '(' + members.length + ')');
                // prepare
                ski.wechat.pay_prepare(function(args) {
                    appId       = args.appid;
                    timestamp   = args.timestamp;
                    nonceStr    = args.noncestr;
                    signature   = args.signature;

                    wx.config({
                        'debug'     : true,        // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        'appId'     : appId,        // 必填，公众号的唯一标识
                        'timestamp' : timestamp,    // 必填，生成签名的时间戳
                        'nonceStr'  : nonceStr,     // 必填，生成签名的随机串
                        'signature' : signature,    // 必填，签名，见附录1
                        'jsApiList' : ['chooseImage', 'uploadImage']            // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                    });
                });
            }

            function append_messages(msgs) {
                for (var i in msgs) {
                    var message = msgs[i];
                    append_message(message);
                }
            }

            function append_message(message) {
                message.message = ski.util.base64.decode(message.message);

                if (issystem(message.member)) $('#container_message').append(ski.ui.message_system(message));
                else {
                    if (isself(message.member)) $('#container_message').append(ski.ui.message_right(message));
                    else $('#container_message').append(ski.ui.message_left(message));
                }

                messages[messages.length] = message;
                $(document.body)[0].scrollTop = (-1>>>2);
            }

            function issystem(member) {
                return -1 == member;
            }

            function isself(member) {
                return platform_account.paid == member;
            }
            
            function send_message() {
                var text = $('.weui_search_input').val();
                if (0 == text.length) return;

                var message = {
                    crid    : chatroom.crid,
                    type    : 0,
                    message : ski.util.base64.encode(text)
                };
                ski.chatroom.message.send(message, null);
                $('.weui_search_input').val('');
            }

            function receive_message_condition() {
                var condition = {};
                if (0 != messages.length) condition.time = messages[messages.length-1].time;
                else condition.time = page_open_time;
                return condition;
            }

            function receive_message_callback(args) {
                if (0 == args.code) {
                    append_messages(args.desc)
                }
            }

            var functions_expande = false;

            function toggle_functions() {
                $('.weui_search_input').blur();

                if(functions_expande) {
                    functions_expande = false;
                    $('#operate_space').css('height', $('#searchbar').outerHeight(true)+'px');
                    $('.weui_search_bar').animate({bottom : '-'+$('#functions').height()+'px'}, 'fast');
                } else {
                    functions_expande = true;
                    $('#operate_space').css('height', $('.weui_search_bar').height()+'px');
                    $('.weui_search_bar').animate({bottom : '0px'}, 'fast');
                }
                scroll_bottom();
            }

            function fn_choose_image() {
                wx.chooseImage({
                    count       : 9, // 默认9
                    sizeType    : ['original', 'compressed'], // 可以指定是原图还是压缩图，默认二者都有
                    sourceType  : ['album', 'camera'], // 可以指定来源是相册还是相机，默认二者都有
                    success     : function (res) {
                        var localIds = res.localIds; // 返回选定照片的本地ID列表，localId可以作为img标签的src属性显示图片
                        for (var i in localIds) {
                            var localId = localIds[i];
                            wx.uploadImage({
                                localId: localId, // 需要上传的图片的本地ID，由chooseImage接口获得
                                isShowProgressTips: 1, // 默认为1，显示进度提示
                                success: function (res) {
                                    var serverId = res.serverId; // 返回图片的服务器端ID
                                    ski.chatroom.message.send({crid : chatroom.crid, type : 1, message : serverId});
                                }
                            });
                        }
                    }
                });
            }

        </script>
    </head>
    <body style="width: 100%; height: 100%; background: #ebebeb">
        <table style='border-collapse: collapse; width: 100%; height: 100%'>
            <tr><td><div id='container_message' style='width: 100%; height: 100%'></div></td></tr>
            <tr id='operate_space' style='height: 46px'><td></td></tr> <!-- space for operate -->
        </table>

        <div class="weui_search_bar" style='position: fixed; z-index: 200; bottom: -120px; width: 100%; padding: 0px; display: block;'>
            <div id='searchbar' style='padding: 8px 10px; '>
                <table style='width: 100%; border-collapse: collapse;'><tr>
                    <td style='padding-right: 10px;'><input type='text' class="weui_search_input" style='width: 100%; height: 28px; border: none; font-size: 16px;' onkeypress="if (event.keyCode==13) send_message();" /></td>
                    <td width='28px'>
                        <div style='position: relative; width: 28px; height: 28px; text-align: center; border: 1px solid gray; border-radius: 20px;' onclick="toggle_functions();">
                            <div style='position: absolute; top: 13px; right: 5px; width: 18px; height: 2px; background-color: gray'></div>
                            <div style='position: absolute; top: 5px; right: 13px; width: 2px; height: 18px; background-color: gray'></div>
                        </div>
                    </td>
                </tr></table>
            </div>
            <div id='functions' style='width: 100%; height: 120px; border-top: 1px solid #c7c7c7; '>
                <table width='100%' height='100%'>
                    <tr>
                        <td style='width: 25%; padding: 15px;'>
                            <div style='margin-left: auto; margin-right: auto; width: 50px; height: 50px; border: 1px solid gray; border-radius: 15px;' onclick='fn_choose_image();'></div>
                            <div style='margin-top: 5px; text-align: center; font-size: 80%; color: gray;'>照片</div>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </body>
</html>
