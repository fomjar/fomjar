<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>☕️聊天室</title>
        <link rel='stylesheet' href='/css/weui.css'/>
        <script type='text/javascript' src='/js/jquery.js'></script>
        <script type='text/javascript' src='/js/jquery.json.js'></script>
        <script type='text/javascript' src='/js/jquery.cookie.js'></script>
        <script type='text/javascript' src='/js/ski.js'></script>
        <script type='text/javascript'>

            var gid = ski.urlparams().gid;
			var game = null;
            var chatroom = null;
            var members  = null;
            var messages = [] 
            var page_open_time = new Date().format('yyyy-MM-dd HH:mm:ss');

            $(document).ready(function() {
                ski.ui.show_toast('获取个人信息');
                ski.common.query_platform_account(function(args) {
                    ski.ui.hide_toast();
                    if (0 != args.code) {
                        ski.ui.show_dialog_alert({
                            head : '获取个人信息失败',
                            body : args.desc
                        });
                        return;
                    }
                    platform_account = args.desc;

                    ski.ui.show_toast('获取聊天室');
                    ski.chatroom.get({gid : gid}, function(args) {
                        ski.ui.hide_toast();
                        if (0 != args.code) {
                            ski.ui.show_dialog_alert({
                                head : '获取聊天室失败',
                                body : args.desc
                            });
                            return;
                        }
                        chatroom = args.desc;
                        chatroom = chatroom[0]; // 先取第一个

                        ski.ui.show_toast('加入聊天室');
                        ski.chatroom.join(chatroom.crid, function(args) {
                            ski.ui.hide_toast();
                            if (0 != args.code) {
                                ski.ui.show_dialog_alert({
                                    head : '加入聊天室失败',
                                    body : args.desc
                                });
                                return;
                            }

                            ski.ui.show_toast('加载成员');
                            ski.chatroom.member(chatroom.crid, function(args) {
                                ski.ui.hide_toast();
                                if (0 != args.code) {
                                    ski.ui.show_dialog_alert({
                                        head : '加载成员失败',
                                        body : args.desc
                                    });
                                    return;
                                }
                                members = args.desc;

                                ski.ui.show_toast('加载消息');
                                ski.chatroom.message.get(chatroom.crid, {count : 100}, function(args) {
                                    ski.ui.hide_toast();
                                    if (0 != args.code) {
                                        ski.ui.show_dialog_alert({
                                            head : '加载消息失败',
                                            body : args.desc
                                        });
                                        return;
                                    }

                                    append_messages(args.desc);

                                    ski.chatroom.message.receive_start(
                                        chatroom.crid,
                                        1000,
                                        receive_message_condition,
                                        receive_message_callback
                                    );
									
									init();
                                });
                            });
                        });
                    });
                });
            });

            function init() {
                $('#message_text').bind('focus', function(){
                    $('#operate_space').css('height', '0px');
                    $('#container_operate').css('position', 'static');
                    $(document.body)[0].scrollTop = (-1>>>2);
                });
                $('#message_text').bind('blur', function(){
                    $('#operate_space').css('height', '44px');
                    $('#container_operate').css('position', 'fixed');
                    $('#container_operate').css('bottom', '0px');
                    $(document.body)[0].scrollTop = (-1>>>2);
                });
				
				ski.ui.set_title('☕️' + chatroom.game.name_zh_cn + '(' + members.length + ')');
            }

            function append_messages(msgs) {
                for (var i in msgs) {
                    var message = msgs[i];
                    append_message(message);
                }
            }

            function append_message(message) {
                message.message = ski.util.base64.decode(message.message);

                if (issystem(message.member)) $('#container_message').append(ski.ui.message_system(message));
                else {
                    if (isself(message.member)) $('#container_message').append(ski.ui.message_right(message));
                    else $('#container_message').append(ski.ui.message_left(message));
                }

                messages[messages.length] = message;
                $(document.body)[0].scrollTop = (-1>>>2);
            }

            function issystem(member) {
                return -1 == member;
            }

            function isself(member) {
                return platform_account.paid == member;
            }
            
            function send_message() {
                var text = $('#message_text').val();
                if (0 == text.length) return;

                var message = {
                    crid    : chatroom.crid,
                    type    : 0,
                    message : ski.util.base64.encode(text)
                };
                ski.chatroom.message.send(message, null);
                $('#message_text').val('');
            }

            function receive_message_condition() {
                var condition = {};
                if (0 != messages.length) condition.time = messages[messages.length-1].time;
                else condition.time = page_open_time;
                return condition;
            }

            function receive_message_callback(args) {
                if (0 == args.code) {
                    append_messages(args.desc)
                }
            }

        </script>
    </head>
    <body style="background: #ebebeb">
        <table style='border-collapse: collapse; width: 100%; height: 100%'>
            <tr><td><div id='container_message' style='width: 100%; height: 100%'></div></td></tr>
            <tr id='operate_space' style='height: 44px'><td></td></tr> <!-- space for operate -->
        </table>

        <div class="weui_search_bar" id="container_operate" style='position: fixed; z-index: 200; bottom: 0px; width: 100%; height: 44px;'>
            <input type='text' class="weui_search_input" id='message_text' style='width: 100%; height: 100%; border: none; font-size: 16px;' onkeypress="if (event.keyCode==13) send_message();">
        </div>
    </body>
</html>
