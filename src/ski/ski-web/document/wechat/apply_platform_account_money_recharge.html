<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'/>
        <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=0'/>
        <title>充值</title>
        <link rel='stylesheet' href='/css/weui.css'/>
        <script type='text/javascript' src='/js/jquery.js'></script>
        <script type='text/javascript' src='/js/jquery.json.js'></script>
        <script type='text/javascript' src='/js/jquery.cookie.js'></script>
        <script type='text/javascript' src='/js/ski.js'></script>
        <script type='text/javascript' src='http://res.wx.qq.com/open/js/jweixin-1.0.0.js'></script>
        <script type='text/javascript'>

            var appId;
            var timestamp;
            var nonceStr;
            var signature;

            $(document).ready(function() {
                // prepare
                ski.wechat.pay_prepare(function(args) {
                    appId       = args.appid;
                    timestamp   = args.timestamp;
                    nonceStr    = args.noncestr;
                    signature   = args.signature;

                    wx.config({
                        'debug'     : false,        // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                        'appId'     : appId,        // 必填，公众号的唯一标识
                        'timestamp' : timestamp,    // 必填，生成签名的时间戳
                        'nonceStr'  : nonceStr,     // 必填，生成签名的随机串
                        'signature' : signature,    // 必填，签名，见附录1
                        'jsApiList' : []            // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                    });
                });
            });

            function apply() {
                // 生成预支付订单
                var money = $('#money').val();
                if (0 == money.length) {
                    ski.ui.show_dialog_alert({
                        head : '错误',
                        body : '金额不能为空'
                    });
                    return;
                }

                ski.ui.show_toast('正在处理');
                ski.wechat.pay_apply(money, function(args) {
                    ski.ui.hide_toast();
                    if ('SUCCESS' == args.return_code) {
                        // 调起支付
                        wx.chooseWXPay({
                            'appId'     : args.pay.appId,     // 必填，公众号的唯一标识
                            'timestamp' : args.pay.timeStamp, // 支付签名时间戳，注意微信jssdk中的所有使用timestamp字段均为小写。但最新版的支付后台生成签名使用的timeStamp字段名需大写其中的S字符
                            'nonceStr'  : args.pay.nonceStr,  // 支付签名随机串，不长于 32 位
                            'package'   : args.pay.package,   // 统一支付接口返回的prepay_id参数值，提交格式如：prepay_id=***）
                            'signType'  : args.pay.signType,  // 签名方式，默认为'SHA1'，使用新版支付需传入'MD5'
                            'paySign'   : args.pay.paySign,   // 支付签名
                            'success'   : function (res) {
                                ski.goto.message({
                                    msg_type    : 'success',
                                    msg_title   : '充值成功',
                                    msg_url     : '/wechat/query_platform_account_money.html'
                                });
                            }
                        });
                    } else {
                        ski.ui.show_dialog_alert({
                            head : "创建订单失败",
                            body : args.return_msg
                        });
                    }
                });
            }
        </script>
    </head>
    <body>
        <div class='cell'>
            <div class='hd'>
                <h1 class='page_title'>充值</h1>
            </div>
            <div class='bd'>
                <div class='weui_cells_title'>选择金额</div>
                <div class='weui_cells'>
                    <div class="weui_cell weui_cell_select weui_select_after">
                        <div class="weui_cell_hd">
                            <label class="weui_label" for="">充值金额</label>
                        </div>
                        <div class="weui_cell_bd weui_cell_primary">
                            <select name="select" class="weui_select" id='money'>
                                <option value="20">20元</option>
                                <option value="50">50元</option>
                                <option value="120" selected='selected'>120元</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class='weui_cells_tips'>账户余额可以全额退款，请放心充值</div>
                <div class='weui_btn_area'>
                    <a class='weui_btn weui_btn_primary' href="javascript: apply();">充值</a>
                </div>
            </div>
        </div>
    </body>
</html>
